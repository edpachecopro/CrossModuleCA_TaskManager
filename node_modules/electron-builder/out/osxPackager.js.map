{
  "version": 3,
  "file": "osxPackager.js",
  "sourceRoot": "",
  "sources": [
    "../src/osxPackager.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import { PlatformPackager, BuildInfo } from \"./platformPackager\"\nimport { Platform, OsXBuildOptions, MasBuildOptions, Arch } from \"./metadata\"\nimport * as path from \"path\"\nimport { Promise as BluebirdPromise } from \"bluebird\"\nimport { log, debug, warn, isEmptyOrSpaces } from \"./util\"\nimport { createKeychain, deleteKeychain, CodeSigningInfo, generateKeychainName, findIdentity, appleCertificatePrefixes, CertType } from \"./codeSign\"\nimport deepAssign = require(\"deep-assign\")\nimport { signAsync, flatAsync, BaseSignOptions, SignOptions, FlatOptions } from \"electron-osx-sign-tf\"\n\n//noinspection JSUnusedLocalSymbols\nconst __awaiter = require(\"./awaiter\")\n\nexport default class OsXPackager extends PlatformPackager<OsXBuildOptions> {\n  codeSigningInfo: Promise<CodeSigningInfo | null>\n\n  constructor(info: BuildInfo, cleanupTasks: Array<() => Promise<any>>) {\n    super(info)\n\n    if (this.options.cscLink == null) {\n      this.codeSigningInfo = BluebirdPromise.resolve(null)\n    }\n    else {\n      const keychainName = generateKeychainName()\n      cleanupTasks.push(() => deleteKeychain(keychainName))\n      this.codeSigningInfo = createKeychain(keychainName, this.options.cscLink, this.getCscPassword(), this.options.cscInstallerLink, this.options.cscInstallerKeyPassword)\n    }\n  }\n\n  get platform() {\n    return Platform.OSX\n  }\n\n  get supportedTargets(): Array<string> {\n    return [\"dmg\", \"mas\"]\n  }\n\n  async pack(outDir: string, arch: Arch, targets: Array<string>, postAsyncTasks: Array<Promise<any>>): Promise<any> {\n    const packOptions = this.computePackOptions(outDir, this.computeAppOutDir(outDir, arch), arch)\n    let nonMasPromise: Promise<any> | null = null\n    if (targets.length > 1 || targets[0] !== \"mas\") {\n      const appOutDir = this.computeAppOutDir(outDir, arch)\n      nonMasPromise = this.doPack(packOptions, outDir, appOutDir, arch, this.customBuildOptions)\n        .then(() => this.sign(appOutDir, null))\n        .then(() => {\n          this.packageInDistributableFormat(appOutDir, targets, postAsyncTasks)\n        })\n    }\n\n    if (targets.includes(\"mas\")) {\n      // osx-sign - disable warning\n      const appOutDir = path.join(outDir, \"mas\")\n      const masBuildOptions = deepAssign({}, this.customBuildOptions, (<any>this.devMetadata.build)[\"mas\"])\n      await this.doPack(Object.assign({}, packOptions, {platform: \"mas\", \"osx-sign\": false, generateFinalBasename: function () { return \"mas\" }}), outDir, appOutDir, arch, masBuildOptions)\n      await this.sign(appOutDir, masBuildOptions)\n    }\n\n    if (nonMasPromise != null) {\n      await nonMasPromise\n    }\n  }\n\n  private static async findIdentity(certType: CertType, name?: string | null): Promise<string | null> {\n    let identity = process.env.CSC_NAME || name\n    if (isEmptyOrSpaces(identity)) {\n      if (process.env.CSC_IDENTITY_AUTO_DISCOVERY === \"false\") {\n        return null\n      }\n      return await findIdentity(certType)\n    }\n    else {\n      identity = identity.trim()\n      for (let prefix of appleCertificatePrefixes) {\n        checkPrefix(identity, prefix)\n      }\n      const result = await findIdentity(certType, identity)\n      if (result == null) {\n        throw new Error(`Identity name \"${identity}\" is specified, but no valid identity with this name in the keychain`)\n      }\n      return result\n    }\n  }\n\n  private async sign(appOutDir: string, masOptions: MasBuildOptions | null): Promise<void> {\n    let codeSigningInfo = await this.codeSigningInfo\n    if (codeSigningInfo == null) {\n      if (process.env.CSC_LINK != null) {\n        throw new Error(\"codeSigningInfo is null, but CSC_LINK defined\")\n      }\n\n      const identity = await OsXPackager.findIdentity(masOptions == null ? \"Developer ID Application\" : \"3rd Party Mac Developer Application\", this.customBuildOptions.identity)\n      if (identity == null) {\n        const message = \"App is not signed: CSC_LINK or CSC_NAME are not specified, and no valid identity in the keychain, see https://github.com/electron-userland/electron-builder/wiki/Code-Signing\"\n        if (masOptions == null) {\n          warn(message)\n          return\n        }\n        else {\n          throw new Error(message)\n        }\n      }\n\n      if (masOptions != null) {\n        const installerName = masOptions == null ? null : (await OsXPackager.findIdentity(\"3rd Party Mac Developer Installer\", this.customBuildOptions.identity))\n        if (installerName == null) {\n          throw new Error(\"Cannot find valid installer certificate: CSC_LINK or CSC_NAME are not specified, and no valid identity in the keychain, see https://github.com/electron-userland/electron-builder/wiki/Code-Signing\")\n        }\n\n        codeSigningInfo = {\n          name: identity,\n          installerName: installerName,\n        }\n      }\n      else {\n        codeSigningInfo = {\n          name: identity,\n        }\n      }\n    }\n    else {\n      if (codeSigningInfo.name == null && masOptions == null) {\n        throw new Error(\"codeSigningInfo.name is null, but CSC_LINK defined\")\n      }\n      if (masOptions != null && codeSigningInfo.installerName == null) {\n        throw new Error(\"Signing is required for mas builds but CSC_INSTALLER_LINK is not specified\")\n      }\n    }\n\n    const identity = codeSigningInfo.name\n    log(`Signing app (identity: ${identity})`)\n\n    const baseSignOptions: BaseSignOptions = {\n      app: path.join(appOutDir, `${this.appName}.app`),\n      platform: masOptions == null ? \"darwin\" : \"mas\",\n      keychain: <any>codeSigningInfo.keychainName,\n      version: this.info.electronVersion\n    }\n\n    const signOptions = Object.assign({\n      identity: identity,\n    }, (<any>this.devMetadata.build)[\"osx-sign\"], baseSignOptions)\n\n    const resourceList = await this.resourceList\n\n    const customSignOptions = masOptions || this.customBuildOptions\n    if (customSignOptions.entitlements != null) {\n      signOptions.entitlements = customSignOptions.entitlements\n    }\n    else {\n      const p = `entitlements.${masOptions == null ? \"osx\" : \"mas\"}.plist`\n      if (resourceList.includes(p)) {\n        signOptions.entitlements = path.join(this.buildResourcesDir, p)\n      }\n    }\n\n    if (customSignOptions.entitlementsInherit != null) {\n      signOptions[\"entitlements-inherit\"] = customSignOptions.entitlementsInherit\n    }\n    else {\n      const p = `entitlements.${masOptions == null ? \"osx\" : \"mas\"}.inherit.plist`\n      if (resourceList.includes(p)) {\n        signOptions[\"entitlements-inherit\"] = path.join(this.buildResourcesDir, p)\n      }\n    }\n\n    await this.doSign(signOptions)\n\n    if (masOptions != null) {\n      const pkg = path.join(appOutDir, `${this.appName}-${this.metadata.version}.pkg`)\n      await this.doFlat(Object.assign({\n        pkg: pkg,\n        identity: codeSigningInfo.installerName,\n      }, baseSignOptions))\n      this.dispatchArtifactCreated(pkg, `${this.metadata.name}-${this.metadata.version}.pkg`)\n    }\n  }\n\n  protected async doSign(opts: SignOptions): Promise<any> {\n    return signAsync(opts)\n  }\n\n  protected async doFlat(opts: FlatOptions): Promise<any> {\n    return flatAsync(opts)\n  }\n\n  protected async computeEffectiveDistOptions(appOutDir: string): Promise<appdmg.Specification> {\n    const specification: appdmg.Specification = deepAssign({\n      title: this.appName,\n      \"icon-size\": 80,\n      contents: [\n        {\n          \"x\": 410, \"y\": 220, \"type\": \"link\", \"path\": \"/Applications\"\n        },\n        {\n          \"x\": 130, \"y\": 220, \"type\": \"file\"\n        }\n      ],\n      format: this.devMetadata.build.compression === \"store\" ? \"UDRO\" : \"UDBZ\",\n    }, this.customBuildOptions)\n\n    if (!(\"icon\" in this.customBuildOptions)) {\n      const resourceList = await this.resourceList\n      if (resourceList.includes(\"icon.icns\")) {\n        specification.icon = path.join(this.buildResourcesDir, \"icon.icns\")\n      }\n      else {\n        warn(\"Application icon is not set, default Electron icon will be used\")\n      }\n    }\n\n    if (!(\"background\" in this.customBuildOptions)) {\n      const resourceList = await this.resourceList\n      if (resourceList.includes(\"background.png\")) {\n        specification.background = path.join(this.buildResourcesDir, \"background.png\")\n      }\n    }\n\n    specification.contents[1].path = path.join(appOutDir, this.appName + \".app\")\n    return specification\n  }\n\n  protected packageInDistributableFormat(appOutDir: string, targets: Array<string>, promises: Array<Promise<any>>): void {\n    for (let target of targets) {\n      if (target === \"dmg\" || target === \"default\") {\n        promises.push(this.createDmg(appOutDir))\n      }\n\n      if (target !== \"mas\" && target !== \"dmg\") {\n        const format = target === \"default\" ? \"zip\" : target\n        log(`Creating OS X ${format}`)\n        // for default we use mac to be compatible with Squirrel.Mac\n        const classifier = target === \"default\" ? \"mac\" : \"osx\"\n        // we use app name here - see https://github.com/electron-userland/electron-builder/pull/204\n        const outFile = path.join(appOutDir, `${this.appName}-${this.metadata.version}-${classifier}.${format}`)\n        promises.push(this.archiveApp(format, appOutDir, outFile)\n          .then(() => this.dispatchArtifactCreated(outFile, `${this.metadata.name}-${this.metadata.version}-${classifier}.${format}`)))\n      }\n    }\n  }\n\n  private async createDmg(appOutDir: string) {\n    const artifactPath = path.join(appOutDir, `${this.appName}-${this.metadata.version}.dmg`)\n    await new BluebirdPromise<any>(async(resolve, reject) => {\n      log(\"Creating DMG\")\n      const dmgOptions = {\n        target: artifactPath,\n        basepath: this.projectDir,\n        specification: await this.computeEffectiveDistOptions(appOutDir),\n      }\n\n      if (debug.enabled) {\n        debug(`appdmg: ${JSON.stringify(dmgOptions, <any>null, 2)}`)\n      }\n\n      const emitter = require(\"appdmg\")(dmgOptions)\n      emitter.on(\"error\", reject)\n      emitter.on(\"finish\", () => resolve())\n      if (debug.enabled) {\n        emitter.on(\"progress\", (info: any) => {\n          if (info.type === \"step-begin\") {\n            debug(`appdmg: [${info.current}] ${info.title}`)\n          }\n        })\n      }\n    })\n\n    this.dispatchArtifactCreated(artifactPath, `${this.metadata.name}-${this.metadata.version}.dmg`)\n  }\n}\n\nfunction checkPrefix(name: string, prefix: string) {\n  if (name.startsWith(prefix)) {\n    throw new Error(`Please remove prefix \"${prefix}\" from the specified name — appropriate certificate will be chosen automatically`)\n  }\n}"
  ]
}
