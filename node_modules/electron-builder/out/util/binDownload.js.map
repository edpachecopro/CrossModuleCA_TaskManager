{
  "version": 3,
  "file": "binDownload.js",
  "sourceRoot": "",
  "sources": [
    "../../src/util/binDownload.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import { statOrNull, spawn, debug, debug7zArgs, getTempName } from \"./util\"\nimport { rename, remove, unlink, emptyDir } from \"fs-extra-p\"\nimport { download } from \"./httpRequest\"\nimport { path7za } from \"7zip-bin\"\nimport * as path from \"path\"\nimport { homedir } from \"os\"\nimport { Promise as BluebirdPromise } from \"bluebird\"\n\n//noinspection JSUnusedLocalSymbols\nconst __awaiter = require(\"./awaiter\")\n\nconst versionToPromise = new Map<string, BluebirdPromise<string>>()\n\n// can be called in parallel, all calls for the same version will get the same promise - will be downloaded only once\nexport function downloadFpm(version: string, osAndArch: string): Promise<string> {\n  return getBin(\"fpm\", `fpm-${version}-${osAndArch}`, `https://github.com/develar/fpm-self-contained/releases/download/v${version}/${`fpm-${version}-${osAndArch}`}.7z`)\n    .then(it => path.join(it, \"fpm\"))\n}\n\nexport function getBinFromBintray(name: string, version: string, sha2?: string): Promise<string> {\n  const dirName = `${name}-${version}`\n  return getBin(name, dirName, `https://dl.bintray.com/electron-userland/bin/${dirName}.7z`, sha2)\n}\n\nexport function getBin(name: string, dirName: string, url: string, sha2?: string): Promise<string> {\n  let promise = versionToPromise.get(dirName)\n  // if rejected, we will try to download again\n  if (promise != null && !promise.isRejected()) {\n    return promise\n  }\n\n  promise = <BluebirdPromise<string>>doGetBin(name, dirName, url, sha2)\n  versionToPromise.set(dirName, promise)\n  return promise\n}\n\n// we cache in the global location - in the home dir, not in the node_modules/.cache (https://www.npmjs.com/package/find-cache-dir) because\n// * don't need to find node_modules\n// * don't pollute user project dir (important in case of 1-package.json project structure)\n// * simplify/speed-up tests (don't download fpm for each test project)\nasync function doGetBin(name: string, dirName: string, url: string, sha2?: string): Promise<string> {\n  const cachePath = path.join(homedir(), \".cache\", name)\n  const dirPath = path.join(cachePath, dirName)\n\n  const dirStat = await statOrNull(dirPath)\n  if (dirStat != null && dirStat.isDirectory()) {\n    debug(`Found existing ${name} ${dirPath}`)\n    return dirPath\n  }\n\n  // 7z cannot be extracted from the input stream, temp file is required\n  const tempUnpackDir = path.join(cachePath, getTempName())\n  const archiveName = `${tempUnpackDir}.7z`\n  debug(`Download ${name} from ${url} to ${archiveName}`)\n  // 7z doesn't create out dir, so, we don't create dir in parallel to download - dir creation will create parent dirs for archive file also\n  await emptyDir(tempUnpackDir)\n  await download(url, archiveName, {\n    skipDirCreation: true,\n    sha2: sha2,\n  })\n\n  await spawn(path7za, debug7zArgs(\"x\").concat(archiveName, `-o${tempUnpackDir}`), {\n    cwd: cachePath,\n  })\n\n  const isOldMethod = sha2 == null\n\n  await BluebirdPromise.all([\n    rename(isOldMethod ? path.join(tempUnpackDir, dirName) : tempUnpackDir, dirPath)\n      .catch(e => {\n        console.warn(`Cannot move downloaded ${name} into final location (another process downloaded faster?): ${e}`)\n      }),\n    unlink(archiveName),\n  ])\n\n  if (isOldMethod) {\n    await remove(tempUnpackDir)\n  }\n\n  debug(`${name}} downloaded to ${dirPath}`)\n  return dirPath\n}"
  ]
}
