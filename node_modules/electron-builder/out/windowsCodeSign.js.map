{
  "version": 3,
  "file": "windowsCodeSign.js",
  "sourceRoot": "",
  "sources": [
    "../src/windowsCodeSign.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import { exec } from \"./util/util\"\nimport { rename } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { release } from \"os\"\nimport { getBinFromBintray } from \"./util/binDownload\"\n//noinspection JSUnusedLocalSymbols\nconst __awaiter = require(\"./util/awaiter\")\n\nconst TOOLS_VERSION = \"1.4.1\"\n\nexport function getSignVendorPath() {\n  return getBinFromBintray(\"winCodeSign\", TOOLS_VERSION, \"bcafcb1aa9be7544ca9bdffda277e4dcf840f14964e51ed270f83fb850cf2e9e\")\n}\n\nexport interface SignOptions {\n  readonly path: string\n\n  readonly cert?: string | null\n  readonly subjectName?: string | null\n\n  readonly name?: string | null\n  readonly password?: string | null\n  readonly site?: string | null\n  readonly hash?: Array<string> | null\n\n  readonly tr?: string | null\n}\n\nexport async function sign(options: SignOptions) {\n  let hashes = options.hash\n  // msi does not support dual-signing\n  if (path.extname(options.path) === \".msi\") {\n    hashes = [hashes != null && !hashes.includes(\"sha1\") ? \"sha256\" : \"sha1\"]\n  }\n  else {\n    if (hashes == null) {\n      hashes = [\"sha1\", \"sha256\"]\n    }\n    else {\n      hashes = Array.isArray(hashes) ? hashes.slice() : [hashes]\n    }\n  }\n\n  const isWin = process.platform === \"win32\"\n  let nest = false\n  //noinspection JSUnusedAssignment\n  let outputPath = \"\"\n  for (let hash of hashes) {\n    outputPath = isWin ? options.path : getOutputPath(options.path, hash)\n    await spawnSign(options, options.path, outputPath, hash, nest)\n    nest = true\n    if (!isWin) {\n      await rename(outputPath, options.path)\n    }\n  }\n}\n\n// on windows be aware of http://stackoverflow.com/a/32640183/1910191\nasync function spawnSign(options: SignOptions, inputPath: string, outputPath: string, hash: string, nest: boolean) {\n  const timestampingServiceUrl = \"http://timestamp.verisign.com/scripts/timstamp.dll\"\n  const isWin = process.platform === \"win32\"\n  const args = isWin ? [\n    \"sign\",\n    nest || hash === \"sha256\" ? \"/tr\" : \"/t\", nest || hash === \"sha256\" ? (options.tr || \"http://timestamp.comodoca.com/rfc3161\") : timestampingServiceUrl\n  ] : [\n    \"-in\", inputPath,\n    \"-out\", outputPath,\n    \"-t\", timestampingServiceUrl\n  ]\n\n  const certificateFile = options.cert\n  if (certificateFile == null) {\n    if (process.platform !== \"win32\") {\n      throw new Error(\"certificateSubjectName supported only on Windows\")\n    }\n    args.push(\"/n\", options.subjectName!)\n  }\n  else {\n    const certExtension = path.extname(certificateFile)\n    if (certExtension === \".p12\" || certExtension === \".pfx\") {\n      args.push(isWin ? \"/f\" : \"-pkcs12\", certificateFile)\n    }\n  }\n\n  if (!isWin || hash !== \"sha1\") {\n    args.push(isWin ? \"/fd\" : \"-h\", hash)\n    if (isWin) {\n      args.push(\"/td\", \"sha256\")\n    }\n  }\n\n  if (options.name) {\n    args.push(isWin ? \"/d\" : \"-n\", options.name)\n  }\n\n  if (options.site) {\n    args.push(isWin ? \"/du\" : \"-i\", options.site)\n  }\n\n  // msi does not support dual-signing\n  if (nest) {\n    args.push(isWin ? \"/as\" : \"-nest\")\n  }\n\n  if (options.password) {\n    args.push(isWin ? \"/p\" : \"-pass\", options.password)\n  }\n\n  if (isWin) {\n    // must be last argument\n    args.push(inputPath)\n  }\n\n  return await exec(await getToolPath(), args)\n}\n\n// async function verify(options: any) {\n//   const out = await exec(await getToolPath(options), [\n//     \"verify\",\n//     \"-in\", options.path,\n//     \"-require-leaf-hash\", options.hash\n//   ])\n//   if (out.includes(\"No signature found.\")) {\n//     throw new Error(\"No signature found\")\n//   }\n//   else if (out.includes(\"Leaf hash match: failed\")) {\n//     throw new Error(\"Leaf hash match failed\")\n//   }\n// }\n\nfunction getOutputPath(inputPath: string, hash: string) {\n  const extension = path.extname(inputPath)\n  return path.join(path.dirname(inputPath), `${path.basename(inputPath, extension)}-signed-${hash}${extension}`)\n}\n\nasync function getToolPath() {\n  if (process.env.USE_SYSTEM_SIGNCODE) {\n    return \"osslsigncode\"\n  }\n\n  let result = process.env.SIGNTOOL_PATH\n  if (result) {\n    return result\n  }\n\n  const vendorPath = await getSignVendorPath()\n  if (process.platform === \"win32\") {\n    return path.join(vendorPath, `windows-${(release().startsWith(\"6.\") ? \"6\" : \"10\")}`, \"signtool.exe\")\n  }\n  else {\n    return path.join(vendorPath, process.platform, \"osslsigncode\")\n  }\n}\n"
  ]
}
